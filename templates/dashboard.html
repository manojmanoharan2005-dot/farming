<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Farming Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Weather API key (embedded) -->
    <meta name="weatherapi-key" content="22f4bcbb814b4ffc914175512252610">

    <!-- Tools panel layout fixes -->
    <style>
        /* Ensure panel uses border-box and inner controls can shrink correctly */
        #topToolsPanel { box-sizing: border-box; overflow: visible; }
        #topToolsPanel .tt-wx-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        #topToolsPanel .tt-wx-row input { flex:1; min-width:0; padding:8px; border:1px solid #e6eef0; border-radius:6px; }
        #topToolsPanel .tt-wx-row button { flex:0 0 auto; white-space:nowrap; padding:8px; border-radius:6px; }
    </style>
</head>
<body class="dashboard-body">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                        <button onclick="this.parentElement.remove()">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="dashboard-container">
        <!-- Green Sidebar -->
        <div class="dashboard-sidebar">
            <div class="sidebar-brand">
                <div class="brand-icon">
                    <i class="fas fa-seedling"></i>
                </div>
                <div class="brand-text">
                    <div class="brand-name">Farming Assistant</div>
                    <div class="brand-tagline">Smart Agriculture Platform</div>
                </div>
            </div>
            
            <div class="user-welcome">
                <div class="welcome-text">
                    <div class="welcome-line">Welcome back,</div>
                    <div class="user-name">{{ user_name }}!</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="{{ url_for('dashboard') }}" class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('crop_suggestion') }}" class="nav-item" data-section="crop-suggestion">
                    <i class="fas fa-seedling"></i>
                    <span>Crop Suggestion</span>
                </a>
                <a href="{{ url_for('fertilizer_advice') }}" class="nav-item" data-section="fertilizer-advice">
                    <i class="fas fa-vial"></i>
                    <span>Fertilizer Advice</span>
                </a>
            </nav>
        </div>
 
        <!-- Main Content -->
        <div class="dashboard-content">
            <!-- Top Header -->
            <div class="top-header">
                <div class="header-left">
                    <h1>Dashboard</h1>
                    <p>Monitor your farm's performance and get insights</p>
                </div>
                <div class="header-right">
                    <!-- Tools button: placed to the LEFT of Today/date as requested -->
                    <div class="top-tools-wrap" style="position:relative;margin-right:12px;display:inline-block;vertical-align:middle;">
                        <button id="topToolsBtn" class="btn btn-outline" aria-expanded="false" aria-controls="topToolsPanel" title="Open Tools" style="padding:8px 10px;border-radius:8px;">
                            <i class="fas fa-tools"></i> Tools
                        </button>

                        <!-- Floating panel (hidden by default) -->
                        <div id="topToolsPanel" style="display:none;position:absolute;right:0;top:42px;width:320px;background:#fff;border-radius:8px;box-shadow:0 8px 24px rgba(2,6,23,0.15);z-index:999;padding:10px;">
                            <div style="display:flex;gap:6px;margin-bottom:8px;">
                                <button class="tt-tab active" data-tab="estimator" style="flex:1;padding:8px;border-radius:6px;border:1px solid #e6eef0;background:#f8fafb;font-weight:600;">Estimator</button>
                                <button class="tt-tab" data-tab="weather" style="flex:1;padding:8px;border-radius:6px;border:1px solid #e6eef0;background:#fff;font-weight:600;">Weather</button>
                            </div>

                            <div id="ttEstimator" class="tt-panel" style="display:block;">
                                <div style="display:grid;gap:8px;">
                                    <label style="font-size:.85rem;color:#556">Area (hectares)</label>
                                    <input id="ttArea" type="number" min="0" step="0.1" value="1" style="padding:8px;border:1px solid #e6eef0;border-radius:6px;">
                                    <label style="font-size:.85rem;color:#556">Seed rate (kg/ha)</label>
                                    <input id="ttSeedRate" type="number" min="0" step="0.1" value="25" style="padding:8px;border:1px solid #e6eef0;border-radius:6px;">
                                    <label style="font-size:.85rem;color:#556">Seed price (â‚¹/kg) â€” optional</label>
                                    <input id="ttSeedPrice" type="number" min="0" step="0.01" placeholder="0.00" style="padding:8px;border:1px solid #e6eef0;border-radius:6px;">
                                    <div style="display:flex;gap:8px;margin-top:6px;">
                                        <button id="ttCalcBtn" class="btn btn-primary" style="flex:1;padding:8px;border-radius:6px;">Calculate</button>
                                        <button id="ttClearBtn" class="btn btn-outline" style="flex:1;padding:8px;border-radius:6px;">Clear</button>
                                    </div>
                                    <div id="ttEstimatorOut" style="margin-top:8px;background:#f8fafb;padding:8px;border-radius:6px;font-size:.95rem;"></div>
                                </div>
                            </div>

                            <div id="ttWeather" class="tt-panel" style="display:none;">
                                <div style="display:flex;flex-direction:column;gap:8px;">
+                                   <div class="tt-wx-row">
+                                       <input id="ttWxLocation" type="text" placeholder="City or 'lat,lon' (e.g., Delhi or 28.6139,77.2090)">
+                                       <button id="ttWxUseMyLoc" class="btn btn-outline">Use my location</button>
+                                   </div>
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <strong>Current</strong>
                                        <button id="ttWxRefresh" class="btn btn-outline" style="padding:6px;border-radius:6px;">Refresh</button>
                                    </div>
                                    <div id="ttWxOut" style="background:#f8fafb;padding:8px;border-radius:6px;">
                                        <div>Loadingâ€¦</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="date-display" style="display:inline-block;vertical-align:middle;">
                        <span>Today</span>
                        <span class="current-date" style="margin-left:8px;">Loading...</span>
                    </div>

                    <!-- Logout button added to the right of the date (Tools -> Today -> Logout) -->
                    <a href="{{ url_for('logout') }}" class="logout-btn" style="display:inline-flex;align-items:center;gap:8px;margin-left:12px;padding:8px 12px;border-radius:8px;background:#ef4444;color:#fff;font-weight:600;text-decoration:none;">
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        Logout
                    </a>
                </div>
            </div>

            <!-- Welcome Banner -->
            <div class="welcome-banner">
                <div class="banner-content">
                    <h2>Good Morning, {{ user_name }}! ðŸ‘‹</h2>
                    <p>Your farm is looking great today. Here's what's happening.</p>
                </div>
                <div class="banner-icon">
                    <i class="fas fa-tractor"></i>
                </div>
            </div>

            <!-- Saved Fertilizers Section -->
            {% if sqlite_fertilizers %}
            <section class="saved-fertilizers-section">
                <h3 class="section-title">Saved Fertilizers</h3>

                <div class="saved-fertilizers-container" data-use-fallback="true">
                    {% for f in sqlite_fertilizers %}
                    <article class="saved-fertilizer-card" id="saved-fertilizer-{{ f.id }}"
                             data-description="{{ f.description or 'No description available for this fertilizer.' }}"
                             data-manual="{{ f.manual or 'Manual steps not provided. Please follow label instructions and local agronomy guidance.' }}"
                             data-safety="{{ f.safety or 'Wear protective gloves and eye protection. Avoid inhalation and follow label first-aid instructions.' }}">
                        <header class="card-top">
                            <div class="card-info">
                                <h4 class="fert-name">{{ f.name }}</h4>
                                <div class="fert-meta">
                                    <span class="status">{{ f.status }}</span>
                                    <time class="date-added" datetime="{{ f.date_added }}">{{ f.date_added.split('T')[0] }}</time>
                                </div>
                            </div>
                            <div class="card-actions">
                                <!-- Form-based delete so server receives a POST and can redirect -->
                                <form method="POST" action="{{ url_for('delete_fertilizer', fertilizer_id=f.id) }}" onsubmit="return confirm('Are you sure you want to delete this saved fertilizer?');" style="display:inline">
                                    <button class="btn btn-delete" type="submit" aria-label="Delete saved fertilizer">Ã—</button>
                                </form>

                                <!-- Keep the JS-aware delete button as fallback (AJAX) â€” dashboard-fertilizers.js will ignore buttons that are inside forms -->
                                <button class="btn btn-delete delete-fertilizer-btn" data-id="{{ f.id }}" aria-label="Delete saved fertilizer (AJAX)" style="display:none">Ã—</button>
                            </div>
                        </header>

                        <div class="card-body">
                            <div class="card-row">
                                <span class="label">Cost</span>
                                <span class="value">â‚¹{{ "{:,.2f}".format(f.cost) }}</span>
                            </div>
                            <div class="card-row">
                                <span class="label">Yield Increase</span>
                                <span class="value">{{ f.yield_increase }}%</span>
                            </div>
                            <div class="card-row">
                                <span class="label">Application Time</span>
                                <span class="value">{{ f.application_time }}</span>
                            </div>
                            <div class="card-actions-row">
                                <!-- View button now opens modal with description, manual steps and safety features -->
                                <button class="btn btn-primary open-recommendation" type="button">View</button>

                                <!-- Buy button now opens maps search for fertilizer shops (JS will handle it) -->
                                <button class="btn btn-outline buy-fertilizer" type="button" data-name="{{ f.name }}">Buy</button>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Saved Crops Section (user-specific) -->
            {% if user_crops %}
            <section class="saved-crops-section">
                <h3 class="section-title">Saved Crops</h3>
                <div class="saved-fertilizers-container">
                    {% for c in user_crops %}
                    <article class="saved-fertilizer-card" id="saved-crop-{{ c.id }}">
                        <header class="card-top">
                            <div class="card-info">
                                <h4 class="fert-name">{{ c.name }}</h4>
                                <div class="fert-meta">
                                    <span class="status">{{ c.season or '' }}</span>
                                    <time class="date-added">{{ (c.created_at.split('T')[0] if c.created_at else '') }}</time>
                                </div>
                            </div>
                            <div class="card-actions">
                                <!-- Delete crop via POST (server will check ownership) -->
                                <form method="POST" action="{{ url_for('delete_crop', crop_id=c.id) }}" onsubmit="return confirm('Are you sure you want to delete this crop?');" style="display:inline">
                                    <button class="btn btn-delete" type="submit" aria-label="Delete saved crop">Ã—</button>
                                </form>
                            </div>
                        </header>

                        <div class="card-body">
                            <div class="card-row">
                                <span class="label">Season</span>
                                <span class="value">{{ c.season or 'â€”' }}</span>
                            </div>
                            <div class="card-row">
                                <span class="label">Name</span>
                                <span class="value">{{ c.name }}</span>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- New: Crop Progress Section -->
            <section class="crop-progress-section">
                <h3 class="section-title">Crop Progress</h3>
                <div id="crop-progress-container" class="saved-fertilizers-container">
                    <!-- Filled dynamically by static/js/progress.js -->
                </div>
            </section>

            <!-- Small inline styles to match project theme -->
            <style>
                .monitoring-card{
                    background:#fff;border-radius:10px;padding:14px;margin-bottom:12px;
                    box-shadow:0 6px 18px rgba(15,23,42,0.04);
                    display:flex;flex-direction:column;gap:8px;
                }
                .monitoring-card .meta{display:flex;justify-content:space-between;align-items:center}
                .progress-bar{background:#eef6ef;border-radius:999px;height:10px;overflow:hidden;width:100%}
                .progress-fill{height:100%;background:linear-gradient(90deg,#10b981,#047857);width:0%}
                .task-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px dashed #eef2f7}
                .task-done{opacity:.6;text-decoration:line-through}
                .btn-mark{background:#10b981;color:#fff;padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
                .btn-mark[disabled]{opacity:.6;cursor:default}
            </style>

            <!-- Load small script to handle delete actions -->
            <script src="{{ url_for('static', filename='js/dashboard-fertilizers.js') }}"></script>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/date-updater.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/top-tools.js') }}"></script>

    <!-- New: Crop progress frontend logic -->
    <script src="{{ url_for('static', filename='js/progress.js') }}"></script>

    <!-- Modal for fertilizer details -->
    <div id="fertilizer-modal" class="modal" role="dialog" aria-hidden="true" style="display:none;">
        <div class="modal-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);"></div>
        <div class="modal-panel" role="document" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;max-width:720px;width:90%;z-index:1001;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.2);">
            <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 id="fertilizer-modal-title" style="margin:0;font-size:1.1rem;">Fertilizer Details</h3>
                <button id="fertilizer-modal-close" aria-label="Close modal" style="background:none;border:none;font-size:20px;cursor:pointer;">Ã—</button>
            </header>

            <section id="fertilizer-modal-content" style="max-height:60vh;overflow:auto;">
                <p id="fertilizer-modal-description" style="margin-bottom:6px;font-size:.98rem;color:#223;">
                    <!-- description populated by JS -->
                </p>

                <!-- NEW: Source indicator so user knows where the text came from -->
                <div id="fertilizer-modal-source" style="margin-bottom:10px;font-size:.85rem;color:#556; font-style:italic;">
                    <!-- populated by JS: "Source: saved data" or "Source: built-in info" -->
                </div>

                <h4 style="margin:10px 0 6px;">Manual Steps</h4>
                <ol id="fertilizer-modal-manual" style="margin:0 0 12px;padding-left:18px;color:#334;">
                    <!-- manual steps populated by JS (plain text will be wrapped into li) -->
                </ol>

                <h4 style="margin:10px 0 6px;">Safety Features & Precautions</h4>
                <ul id="fertilizer-modal-safety" style="margin:0 0 8px;padding-left:18px;color:#334;">
                    <!-- safety items populated by JS (plain text split into li) -->
                </ul>
            </section>

            <footer style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                <button id="fertilizer-modal-open-maps" class="btn btn-outline" type="button">Find Shops</button>
                <button id="fertilizer-modal-close-2" class="btn btn-primary" type="button">Close</button>
            </footer>
        </div>
    </div>

    <!-- Minimal inline modal styles can be adjusted in css/style.css later -->
    <style>
        .modal{display:none;position:fixed;inset:0;z-index:1050}
        .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.5);}
        .modal-panel{position:relative;background:#fff;border-radius:.5rem;box-shadow:0 4px 8px rgba(0,0,0,0.1);max-width:90%;margin:auto;top:10%;}
        .modal-header,.modal-footer{padding:1rem;display:flex;justify-content:flex-end;gap:.5rem}
        .modal-title{margin:0;font-size:1.25rem}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer}
        .modal-body{padding:1rem;max-height:60vh;overflow:auto}
        .btn{padding:.5rem 1rem;border-radius:.375rem;border:none;cursor:pointer}
        .btn-primary{background:#007bff;color:#fff}
        .btn-outline{background:#f8f9fa;color:#333}
    </style>
</body>
</html>
